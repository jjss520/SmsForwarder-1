name: Weekly Build

# è§¦å‘å™¨ï¼šæ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      root_sol:
        description: "Build Title"
        required: true
        default: "SmsForwarder"

# âš ï¸ å…³é”®ï¼šèµ‹äºˆå†™æƒé™ï¼Œå¦åˆ™æ— æ³•åˆ›å»º Release
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      output: "${{ github.workspace }}/build/app/outputs/apk/release"
    steps:
      # 1. æ£€å‡ºä»£ç 
      - uses: actions/checkout@v4
      
      # 2. åˆ é™¤æ—§çš„å·¥ä½œæµè®°å½• (ä¿æŒé¡µé¢æ•´æ´)
      - name: Delete Old Workflows
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0
          delete_workflow_pattern: 'Weekly Build'
          
      # 3. è®¾ç½® JDK 11
      - name: set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '11'
          java-package: jdk
          
      # 4. è·å–æ‰“åŒ…ç§˜é’¥ (æ³¨æ„ä»“åº“åœ°å€)
      - name: Checkout Android Keystore
        uses: actions/checkout@v4
        with:
          repository: jjss520/keystore   # âš ï¸ ç¡®è®¤è¿™æ˜¯ä½ çš„ç§æœ‰ä»“åº“
          token: ${{ secrets.TOKEN }}
          path: keystore
          
      # 5. å¼€å§‹ç¼–è¯‘
      - name: Build with Gradle
        run: bash ./gradlew assembleRelease
      
      # 6. è§£æç‰ˆæœ¬å· (ä¸ºäº†ç»™ Release å‘½å)
      - name: Parse output-metadata.json
        run: |
          metadata_file="${{ env.output }}/output-metadata.json"
          # åªè¦æ‰¾åˆ°ä¸€ä¸ª apk æ–‡ä»¶å³å¯æå–ç‰ˆæœ¬ä¿¡æ¯
          apk=$(jq -r '.elements[0].outputFile' "$metadata_file")
          
          if [[ $apk =~ SmsF_([^_]+)_([^_]+)_(.+)_release.apk ]]; then
              versionName="${BASH_REMATCH[1]}"
              versionCode="${BASH_REMATCH[2]}"
              
              # å†™å…¥ç¯å¢ƒå˜é‡
              echo "ver_name=$versionName" >> $GITHUB_ENV
              echo "ver_code=${versionCode: -3}" >> $GITHUB_ENV # å–æœ€å3ä½
              
              echo "âœ… è§£ææˆåŠŸ: v$versionName ($versionCode)"
          else
              echo "âŒ è§£ææ–‡ä»¶åå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ—¶é—´æˆ³ä½œä¸ºç‰ˆæœ¬å·"
              echo "ver_name=$(date +%Y%m%d)" >> $GITHUB_ENV
              echo "ver_code=$(date +%H%M)" >> $GITHUB_ENV
          fi

      # 7. å‘å¸ƒåˆ° GitHub Releases ğŸš€
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          # Tag å‘½åæ ¼å¼ï¼šv3.3.3_100054 (è¿™æ ·æ¯æ¬¡ç‰ˆæœ¬å·å˜åŠ¨éƒ½ä¼šå‘æ–°ç‰ˆ)
          tag_name: v${{ env.ver_name }}_${{ env.ver_code }}
          name: SmsForwarder v${{ env.ver_name }} (Build ${{ env.ver_code }})
          body: |
            è‡ªåŠ¨åŒ–ç¼–è¯‘æ„å»º
            - åŒ…å« IPv6 æŸ¥è¯¢æ¥å£è¡¥ä¸
            - ç¼–è¯‘æ—¶é—´: ${{ steps.date.outputs.date }}
          draft: false
          prerelease: false
          # ä½¿ç”¨é€šé…ç¬¦ä¸Šä¼ æ‰€æœ‰ APK
          files: ${{ env.output }}/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }} # ä½¿ç”¨ä½ çš„ TOKEN æ‰æœ‰æƒé™å‘å¸ƒ

      # 8. (å¯é€‰) ä¾ç„¶ä¿ç•™ Artifacts å¤‡ä»½ï¼Œé˜²æ­¢ Release å¤±è´¥æ²¡åœ°æ–¹ä¸‹
      - name: Upload Artifacts Backup
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "SmsForwarder_v${{ env.ver_name }}_All_APKs"
          path: "${{ env.output }}/*.apk"
