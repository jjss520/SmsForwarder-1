name: Weekly Build

# 触发器
on:
  schedule:
    - cron: '0 15 * * 0' #每周天在国际标准时间15点(北京时间+8，即 23:00)
  workflow_dispatch:
    inputs:
      root_sol:
        description: "Weekly Build Title"
        required: true
        default: "SmsForwarder"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      output: "${{ github.workspace }}/build/app/outputs/apk/release"
    steps:
      # 检出代码
      - uses: actions/checkout@v4
      # 删除旧的工作流
      - name: Delete Weekly Build
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0 # 全部删除只留正在跑的一条
          keep_minimum_runs: 0 # 全部删除只留正在跑的一条
          delete_workflow_pattern: 'Weekly Build'
      # 设置jdk环境为11
      - name: set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '11'
          java-package: jdk
      # 获取打包秘钥
      - name: Checkout Android Keystore
        uses: actions/checkout@v4
        with:
          repository: jjss520/keystore   # ⚠️ 注意：这里要确保是你自己的私有仓库地址
          token: ${{ secrets.TOKEN }} # 连接仓库的token,需要单独配置
          path: keystore # 仓库的根目录名
      # 打包release
      - name: Build with Gradle
        run: bash ./gradlew assembleRelease
      
      # ✅ 修改点：只解析版本号，不上传 XUpdate
      - name: Parse output-metadata.json (Extract Version Info)
        run: |
          metadata_file="${{ env.output }}/output-metadata.json"
          
          # 遍历 elements，并从 outputFile 中提取 versionName 和 versionCode
          jq -r '.elements | sort_by(.outputFile) | .[].outputFile' "$metadata_file" |
          while IFS= read -r apk; do
              echo "APK: $apk"
              # 使用正则表达式从文件名中提取 versionName、versionCode 和 ABI
              if [[ $apk =~ SmsF_([^_]+)_([^_]+)_(.+)_release.apk ]]; then
                  versionName="${BASH_REMATCH[1]}"
                  versionCode="${BASH_REMATCH[2]}"
                  abi="${BASH_REMATCH[3]}"
                  
                  # 将提取到的版本号写入环境变量，供后续步骤使用
                  echo "ver_name=$versionName" >> $GITHUB_ENV
                  echo "ver_code=${versionCode: -3}" >> $GITHUB_ENV
                  
                  echo "Extracted: $versionName / $versionCode"
              fi
          done

      # 存档打包的文件
      - name: Upload App To Artifact universal
        if: success () || failure ()
        uses: actions/upload-artifact@v4
        with:
          name: "SmsF_${{ env.ver_name }}_100${{ env.ver_code }}_universal_release.apk"
          path: "${{ env.output }}/SmsF_*_universal_release.apk"
          
      - name: Upload App To Artifact armeabi-v7a
        if: success () || failure ()
        uses: actions/upload-artifact@v4
        with:
          name: "SmsF_${{ env.ver_name }}_200${{ env.ver_code }}_armeabi-v7a_release.apk"
          path: "${{ env.output }}/SmsF_*_armeabi-v7a_release.apk"
          
      - name: Upload App To Artifact arm64-v8a
        if: success () || failure ()
        uses: actions/upload-artifact@v4
        with:
          name: "SmsF_${{ env.ver_name }}_300${{ env.ver_code }}_arm64-v8a_release.apk"
          path: "${{ env.output }}/SmsF_*_arm64-v8a_release.apk"
          
      - name: Upload App To Artifact x86
        if: success () || failure ()
        uses: actions/upload-artifact@v4
        with:
          name: "SmsF_${{ env.ver_name }}_400${{ env.ver_code }}_x86_release.apk"
          path: "${{ env.output }}/SmsF_*_x86_release.apk"
          
      - name: Upload App To Artifact x86_64
        if: success () || failure ()
        uses: actions/upload-artifact@v4
        with:
          name: "SmsF_${{ env.ver_name }}_500${{ env.ver_code }}_x86_64_release.apk"
          path: "${{ env.output }}/SmsF_*_x86_64_release.apk"
